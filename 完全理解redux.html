<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
   <!--  <script>
        let state = {
            count: 1
        }
        let listeners = [];

        function subscribe(listener) {
            listeners.push(listener);    
        }

        function changeCount(count) {
            state.count = count;
            for (let i=0; i<listeners.length; i++) {
                const listener = listeners[i];
                listener();
            }
        }

        subscribe(() => {
            console.log(state.count);
        })

        changeCount(2)
        changeCount(3)
        changeCount(4)
        
    </script> -->

    <script>
        let initState = {
            count: 0
        }
        function counterReducer(state, action) {
            if (!state) {
                state = initState;
            }
            switch (action.type) {
                case 'INCREMENT':
                    return {
                        ...state,
                        count: state.count + 1
                    }
                case 'DECREMENT':
                    return {
                        ...state,
                        count: state.count - 1
                    }
                default:
                    return state
            }
        }
        function InfoReducer(state, action) {
            switch (action.type) {
                case 'SET_NAME':
                    return {
                        ...state,
                        name: action.name
                    }
                case 'SET_DESCRIPTION':
                    return {
                        ...state,
                        description: action.description
                    }
                default:
                    return state
            }
        }

        function combineReducers(reducers) {
            const reducerKeys = Object.keys(reducers);

            return function combination(state = {}, action) {
                const nextState = {} 
                // debugger
                for (let i=0; i<reducerKeys.length; i++) {
                    const key = reducerKeys[i];
                    const reducer = reducers[key];
                    const previousStateForKey = state[key];
                    const nextStateForKey = reducer(previousStateForKey, action)

                    nextState[key] = nextStateForKey
                    // debugger
                }
                console.log(nextState)
                // debugger
                return nextState;
            }
        }

        const createStore = function(reducer, initState) {
            let state = initState;
            let listeners = [];

            // 订阅 - 订阅做的事情就是收集状态改变之后要处理的函数
            function subscribe(listener) {
                listeners.push(listener)
            }

            function dispatch(action) {
                state = reducer(state, action);
                // 通知
                for(let i=0; i<listeners.length; i++) {
                    const listener = listeners[i];
                    listener();
                }
            }

            function getState() {
                return state;
            }

            dispatch({ type: Symbol() })

            return {
                subscribe,
                dispatch,
                getState
            }
        }

        

    
        // 实现一个自增、自减的计数器
        /* let initState = {
            counter: {
                count: 0
            },
            info: {
                name: '前端第九部',
                description: '我们都是前端爱好者'
            }
        } */
        
        const reducer = combineReducers({
            counter: counterReducer,
            info: InfoReducer
        })
        let store = createStore(reducer);
        console.dir(store.getState());


        /* store.subscribe(() => {
            let state = store.getState();
            console.log(state.counter.count, state.info.name, state.info.description);
        })

        store.dispatch({
            type: 'INCREMENT'
        })

        store.dispatch({
            type: 'DECREMENT'
        }) */

        /* store.dispatch({
            count: 'abc'
        }) */
    
    </script>
</body>
</html>